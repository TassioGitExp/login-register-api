<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="header.css">
    <link rel="stylesheet" type="text/css" href="footer.css">
    <link rel="stylesheet" type="text/css" href="home.css">
    <title>Home</title>
</head>
<body>
    <div id="cookiesWarning" style="position:absolute; width: 100%; height: 100%; z-index: 10;">
        <div style="position: absolute; width: 100%; height: 100%; z-index: 11; background-color: black; opacity: 30%;"></div>
        <div class="mx-auto" style="position: relative; margin-top: 30px; width: 200px; height: 200px; background-color: blue; z-index: 12;">
            <p class="text-center" style="color: aliceblue;">ESSE WEBSITE USA COOKIES</p>
            <button onclick="acceptCookies()">aceitar</button>
            <button onclick="denyCookies()">Deny</button>
        </div>
    </div>
    
    <nav th:replace="fragments/header.html :: th-navbar"></nav>
    <div class="container" id="container-div">
        <div class="row mx-auto" id="row-div">
            <div class="col-6 mx-auto" id="col1">
                <img class="mx-auto my-auto d-block" src="images/blank-profile-picture.png" alt="User picture" id="profile-picture">
                <h2 class="text-center" style="color: #5a5a5a; margin-top: 3px;">John Doe</h2>
                <button onclick="signOut()">Sign out</button>
            </div>
            <div class="col-6 mx-auto" id="col2">
                <div class="user-data-div mx-auto my-auto">
                    <div class="user-data container-fluid" style="border-bottom: 2px solid #979A9A;">
                        <h5 class="user-data-text text-center" style="color: #5a5a5a;">EMAIL</h5>
                        <p class="user-data-text text-center" style="margin-bottom: 5px;">email@email.com.br</p>
                    </div>
                    <div class="user-data container-fluid" style="border-bottom: 2px solid #979A9A;">
                        <h5 class="user-data-text text-center" style="padding-top: 5px; color: #5a5a5a;">PASSWORD</h5>
                        <p class="user-data-text text-center" style="margin-bottom: 5px;">password123</p>
                    </div>
                    <div class="user-data container-fluid">
                        <h5 class="user-data-text text-center" style="padding-top: 5px; color: #5a5a5a;">DATE OF BIRTH</h5>
                        <p class="user-data-text text-center" style="margin-bottom: 0;">01/02/2001</p>
                    </div>
                </div>  
            </div>
        </div>
    </div>
    <div th:replace="fragments/footer.html :: th-footer"></div>

    <script>
        window.onload = verifyCookie();
        //window.onbeforeunload = userOnlineFalse(); // Resolver isso.

        function userOnlineFalse(){
            console.log("user is now offline.");
            var userCookie = getCookie("userCookie");
            
            if (userCookie != null) {
                
                userCookie = JSON.parse(userCookie.replace("expires=Tue, 01 Jan 2115 12:00:00 UTC", ""));
            
                var id = userCookie.id;

                fetch('/users/user-offline?id='+id, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-type': 'text/plain;charset=UTF-8'
                }})
                .then(function (response) {
                    if (response.ok) {
                        //console.log("response: \n"+response.text);
                        return response.json;
                    }
                    return Promise.reject(response);
                })
                .then(function (data) {
                
                    setCookie("userCookie", JSON.stringify(userCookie), "expires=Tue, 01 Jan 2115 12:00:00 UTC");
                    
                })
                .catch(function (error) {
                    console.warn('Something went wrong.', error);});
            } 
        }

        function signOut(){
            console.log("signing out.");
            var userCookie = getCookie("userCookie");
            
            if (userCookie != null) {
                
                userCookie = JSON.parse(userCookie.replace("expires=Tue, 01 Jan 2115 12:00:00 UTC", ""));
            
                var id = userCookie.id;

                fetch('/users/sign-out?id='+id, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-type': 'text/plain;charset=UTF-8'
                }})
                .then(function (response) {
                    if (response.ok) {
                        //console.log("response: \n"+response.text);
                        return response.json;
                    }
                    return Promise.reject(response);
                })
                .then(function (data) {
                    userCookie.online = false;
                    userCookie.rememberMe = false;

                    userCookie = JSON.stringify(userCookie);
                    setCookie("userCookie", userCookie, "expires=Tue, 01 Jan 2115 12:00:00 UTC");
                    
                    window.location.href = "/sign-in";
                })
                .catch(function (error) {
                    console.warn('Something went wrong.', error);});
            }
        }
        
        var myCookie = {
            cookieStatus: "ok"
        };
         
        var myCookieJson = JSON.stringify(myCookie);

        function acceptCookies(){ // OK
            setCookie("myCookie", myCookieJson, "expires=Tue, 01 Jan 2115 12:00:00 UTC");
            
            var element = document.getElementById("cookiesWarning");
            element.parentNode.removeChild(element);
            
            accepted = true;
            console.log("cookies accepted");
            console.log("cookie criado");
        }

        function denyCookies(){
            var element = document.getElementById("cookiesWarning");
            element.parentNode.removeChild(element);
            console.log("cookies denied.");
        }

        function verifyCookie() {
           
            var userCookie = getCookie("userCookie"); // Verifica cookies do usuário
            console.log("verificando userCookie...");
            
            if (userCookie != null) {
                console.log("userCookie exists.");
                userCookie = JSON.parse(userCookie.replace("expires=Tue, 01 Jan 2115 12:00:00 UTC", ""));
                
                if(userCookie.online == false && userCookie.rememberMe == false) {
                    userCookie = JSON.stringify(userCookie);
                    setCookie("userCookie", userCookie, "expires=Tue, 01 Jan 2115 12:00:00 UTC");
                    
                    window.location.href = "/sign-in";
                }else if (userCookie.rememberMe == true && userCookie.online==false) {
                    userCookie = JSON.stringify(userCookie);
                    setCookie("userCookie", userCookie, "expires=Tue, 01 Jan 2115 12:00:00 UTC");
                    
                    window.location.href = "/sign-in"; // faz a verificação padrao
                }
            } else {
                console.log("userCookie não existe.");
                window.location.href = "/sign-in";
            }
            
            var myCookie = getCookie("myCookie"); // Verifica aceitação de cookies
            console.log("verificando myCookie.");
            
            if (myCookie != null) { //Se cookie existe
                var element = document.getElementById("cookiesWarning");
                element.parentNode.removeChild(element);//Não mostra botao para aceitar cookies
                console.log("cookie de aceitação existe.");
            } else
                console.log("cookie de aceitação não existe.");
        }

        function setCookie(name,value,expires) {
            var expireDate = expires;
            document.cookie = name + "=" + (value || "")  + expireDate + "; path=/";
        }
        
        function getCookie(name) {
            var cookieName = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') 
                    c = c.substring(1,c.length);
                if (c.indexOf(cookieName) == 0) 
                    return c.substring(cookieName.length,c.length);
            }
            return null;
        }
        
        function eraseCookie(name) {   
            document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
    
    </script>

</body>
</html>